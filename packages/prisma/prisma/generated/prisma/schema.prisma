model CartItem {
  id            String   @id @default(cuid())
  userId        String   @map("user_id")
  productId     String?  @map("product_id")
  medicineId    String?  @map("medicine_id")
  combinationId String?  @map("combination_id")
  quantity      Int      @default(1)
  price         Decimal? @db.Decimal(10, 2) // Snapshot price at time of adding
  addedAt       DateTime @default(now()) @map("added_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  product  Product?  @relation(fields: [productId], references: [id], onDelete: Cascade)
  medicine Medicine? @relation(fields: [medicineId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@unique([userId, medicineId])
  @@index([userId])
  @@index([productId])
  @@index([medicineId])
  @@map("cart_items")
}

model Coupon {
  id            String  @id @default(cuid())
  code          String  @unique
  name          String
  description   String? @db.Text
  discountType  String  @map("discount_type") // PERCENTAGE, FIXED
  discountValue Decimal @map("discount_value") @db.Decimal(10, 2)

  // Constraints
  minOrderValue    Decimal? @map("min_order_value") @db.Decimal(10, 2)
  maxDiscountValue Decimal? @map("max_discount_value") @db.Decimal(10, 2)
  maxUsageTotal    Int?     @map("max_usage_total")
  maxUsagePerUser  Int?     @map("max_usage_per_user")

  // Validity
  startDate  DateTime @map("start_date")
  expiryDate DateTime @map("expiry_date")

  // Status
  isActive  Boolean @default(true) @map("is_active")
  usedCount Int     @default(0) @map("used_count")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  orders      Order[]
  userCoupons UserCoupon[]

  @@index([code])
  @@index([isActive])
  @@index([expiryDate])
  @@map("coupons")
}

model UserCoupon {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  couponId  String   @map("coupon_id")
  usedCount Int      @default(0) @map("used_count")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  coupon Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)

  @@unique([userId, couponId])
  @@index([userId])
  @@index([couponId])
  @@map("user_coupons")
}

enum UserRole {
  USER
  ADMIN
  VENDOR
  SUPPORT
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentProvider {
  RAZORPAY
  STRIPE
  PAYPAL
  COD
}

model Medicine {
  id                String   @id @default(cuid())
  name              String
  slug              String   @unique
  price             Decimal  @db.Decimal(10, 2)
  compareAtPrice    Decimal? @map("compare_at_price") @db.Decimal(10, 2)
  stock             Int      @default(0)
  isDiscontinued    Boolean  @default(false) @map("is_discontinued")
  isPrescriptionReq Boolean  @default(true) @map("is_prescription_required")
  imageUrl          String?  @map("image_url")

  // Basic Information
  manufacturerName String  @map("manufacturer_name")
  type             String // Tablet, Capsule, Syrup, etc.
  packSizeLabel    String  @map("pack_size_label")
  packageDetail    String? @map("package_detail")
  package          String?
  productForm      String? @map("product_form")

  // Composition
  saltComposition String? @map("salt_composition") @db.Text
  composition1    String? @db.Text
  composition2    String? @db.Text

  // Medical Information
  introduction String? @db.Text
  benefits     String? @db.Text
  description  String? @db.Text
  primaryUse   String? @map("primary_use") @db.Text
  howItWorks   String? @map("how_it_works") @db.Text
  keyBenefits  String? @map("key_benefits") @db.Text

  // Usage Instructions
  howToUse         String? @map("how_to_use") @db.Text
  directionsForUse String? @map("directions_for_use") @db.Text
  ifMiss           String? @map("if_miss") @db.Text
  storage          String? @db.Text

  // Safety & Side Effects
  safetyAdvise     String? @map("safety_advise") @db.Text
  commonSideEffect String? @map("common_side_effect") @db.Text

  // Interactions
  alcoholInteraction   String? @map("alcohol_interaction") @db.Text
  pregnancyInteraction String? @map("pregnancy_interaction") @db.Text
  lactationInteraction String? @map("lactation_interaction") @db.Text
  drivingInteraction   String? @map("driving_interaction") @db.Text
  kidneyInteraction    String? @map("kidney_interaction") @db.Text
  liverInteraction     String? @map("liver_interaction") @db.Text
  interaction          String? @db.Text

  // Additional Details
  factBox             String? @map("fact_box") @db.Text
  useOf               String? @map("use_of") @db.Text
  manufacturerAddress String? @map("manufacturer_address") @db.Text
  countryOfOrigin     String? @map("country_of_origin")
  manufacturerDetails String? @map("manufacturer_details") @db.Text
  marketerDetails     String? @map("marketer_details") @db.Text
  expiration          String?
  reference           String? @db.Text
  qa                  String? @map("q_a") @db.Text

  // Metrics
  viewCount   Int      @default(0) @map("view_count")
  salesCount  Int      @default(0) @map("sales_count")
  avgRating   Decimal? @default(0) @map("avg_rating") @db.Decimal(3, 2)
  reviewCount Int      @default(0) @map("review_count")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  cartItems  CartItem[]
  orderItems OrderItem[]
  reviews    Review[]
  wishlists  Wishlist[]

  @@index([slug])
  @@index([name])
  @@index([manufacturerName])
  @@index([type])
  @@index([isDiscontinued])
  @@index([isPrescriptionReq])
  @@index([price])
  @@index([salesCount])
  @@map("medicines")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  type      String // ORDER_UPDATE, PROMOTION, SYSTEM
  title     String
  message   String   @db.Text
  data      Json? // Additional context
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model Order {
  id            String      @id @default(cuid())
  orderNumber   String      @unique @map("order_number") // Human-readable order number
  userId        String      @map("user_id")
  addressId     String      @map("address_id")
  status        OrderStatus @default(PENDING)
  paymentMethod String      @map("payment_method")

  // Pricing
  subtotal     Decimal @db.Decimal(10, 2)
  discount     Decimal @default(0) @map("discount_amount") @db.Decimal(10, 2)
  tax          Decimal @default(0) @db.Decimal(10, 2)
  shippingCost Decimal @default(0) @map("shipping_cost") @db.Decimal(10, 2)
  total        Decimal @map("total_amount") @db.Decimal(10, 2)

  // Coupon
  couponId   String? @map("coupon_id")
  couponCode String? @map("coupon_code")

  // Tracking
  trackingNumber String? @map("tracking_number")
  carrier        String?

  // Notes
  customerNotes String? @map("customer_notes") @db.Text
  internalNotes String? @map("internal_notes") @db.Text

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  confirmedAt DateTime? @map("confirmed_at")
  shippedAt   DateTime? @map("shipped_at")
  deliveredAt DateTime? @map("delivered_at")
  cancelledAt DateTime? @map("cancelled_at")

  // Relations
  user          User                 @relation(fields: [userId], references: [id], onDelete: Restrict)
  address       UserAddress          @relation(fields: [addressId], references: [id], onDelete: Restrict)
  coupon        Coupon?              @relation(fields: [couponId], references: [id])
  orderItems    OrderItem[]
  payments      Payment[]
  statusHistory OrderStatusHistory[]

  @@index([userId])
  @@index([addressId])
  @@index([orderNumber])
  @@index([status])
  @@index([createdAt])
  @@index([couponId])
  @@map("orders")
}

model OrderItem {
  id            String  @id @default(cuid())
  orderId       String  @map("order_id")
  productId     String? @map("product_id")
  medicineId    String? @map("medicine_id")
  combinationId String? @map("combination_id")

  // Item details (snapshot at time of order)
  name     String
  sku      String?
  quantity Int
  price    Decimal @db.Decimal(10, 2) // Unit price
  discount Decimal @default(0) @db.Decimal(10, 2)
  tax      Decimal @default(0) @db.Decimal(10, 2)
  total    Decimal @db.Decimal(10, 2) // Total for this line item

  status OrderStatus @default(PENDING)
  reason String?     @db.Text // Cancellation/return reason

  // Relations
  order       Order                      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product?                   @relation(fields: [productId], references: [id], onDelete: SetNull)
  medicine    Medicine?                  @relation(fields: [medicineId], references: [id], onDelete: SetNull)
  combination ProductVariantCombination? @relation(fields: [combinationId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([productId])
  @@index([medicineId])
  @@index([status])
  @@map("order_items")
}

model OrderStatusHistory {
  id        String      @id @default(cuid())
  orderId   String      @map("order_id")
  status    OrderStatus
  notes     String?     @db.Text
  createdAt DateTime    @default(now()) @map("created_at")

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([createdAt])
  @@map("order_status_history")
}

model Payment {
  id                String          @id @default(cuid())
  orderId           String          @map("order_id")
  userId            String          @map("user_id")
  amount            Decimal         @db.Decimal(10, 2)
  currency          String          @default("INR")
  status            PaymentStatus   @default(PENDING)
  provider          PaymentProvider
  providerPaymentId String?         @unique @map("provider_payment_id")
  providerOrderId   String?         @map("provider_order_id")

  // Payment metadata
  method       String? // card, upi, netbanking, wallet
  metadata     Json?
  errorCode    String? @map("error_code")
  errorMessage String? @map("error_message") @db.Text

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  completedAt DateTime? @map("completed_at")
  failedAt    DateTime? @map("failed_at")

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Restrict)
  user  User  @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([orderId])
  @@index([userId])
  @@index([status])
  @@index([providerPaymentId])
  @@index([createdAt])
  @@map("payments")
}

model Category {
  id           String   @id @default(cuid())
  name         String   @unique
  slug         String   @unique
  description  String?
  imageUrl     String?  @map("image_url")
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  subCategories SubCategory[]

  @@index([slug])
  @@index([isActive])
  @@index([displayOrder])
  @@map("categories")
}

model SubCategory {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  description  String?
  imageUrl     String?  @map("image_url")
  categoryId   String   @map("category_id")
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  category Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  products Product[]

  @@index([categoryId])
  @@index([slug])
  @@index([isActive])
  @@index([displayOrder])
  @@map("sub_categories")
}

model Product {
  id                String   @id @default(cuid())
  name              String
  slug              String   @unique
  description       String   @db.Text
  shortDescription  String?  @map("short_description") @db.VarChar(500)
  price             Decimal  @db.Decimal(10, 2)
  compareAtPrice    Decimal? @map("compare_at_price") @db.Decimal(10, 2)
  costPrice         Decimal? @map("cost_price") @db.Decimal(10, 2)
  stock             Int      @default(0)
  lowStockThreshold Int      @default(10) @map("low_stock_threshold")
  sku               String?  @unique
  barcode           String?  @unique
  weight            Decimal? @db.Decimal(8, 2)
  dimensions        String? // JSON: {length, width, height}
  imageUrl          String   @map("image_url")
  isActive          Boolean  @default(true) @map("is_active")
  isFeatured        Boolean  @default(false) @map("is_featured")
  isPrescriptionReq Boolean  @default(false) @map("is_prescription_required")
  viewCount         Int      @default(0) @map("view_count")
  salesCount        Int      @default(0) @map("sales_count")
  avgRating         Decimal? @default(0) @map("avg_rating") @db.Decimal(3, 2)
  reviewCount       Int      @default(0) @map("review_count")
  subCategoryId     String   @map("sub_category_id")

  // Extended product information
  manufacturer        String?
  manufacturerAddress String? @map("manufacturer_address") @db.Text
  type                String?
  packaging           String?
  packageQty          String? @map("package_qty")
  productForm         String? @map("product_form")
  productHighlights   String? @map("product_highlights") @db.Text
  information         String? @db.Text
  keyIngredients      String? @map("key_ingredients") @db.Text
  keyBenefits         String? @map("key_benefits") @db.Text
  directionsForUse    String? @map("directions_for_use") @db.Text
  safetyInformation   String? @map("safety_information") @db.Text
  countryOfOrigin     String? @map("country_of_origin")
  manufacturerDetails String? @map("manufacturer_details") @db.Text
  marketerDetails     String? @map("marketer_details") @db.Text

  // SEO fields
  metaTitle       String? @map("meta_title")
  metaDescription String? @map("meta_description")
  metaKeywords    String? @map("meta_keywords")

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  publishedAt DateTime? @map("published_at")

  // Relations
  subCategory  SubCategory                 @relation(fields: [subCategoryId], references: [id], onDelete: Restrict)
  cartItems    CartItem[]
  orderItems   OrderItem[]
  variantTypes VariantType[]
  combinations ProductVariantCombination[]
  images       ProductImage[]
  wishlists    Wishlist[]
  reviews      Review[]

  @@index([slug])
  @@index([subCategoryId])
  @@index([isActive])
  @@index([isFeatured])
  @@index([price])
  @@index([stock])
  @@index([avgRating])
  @@index([salesCount])
  @@index([createdAt])
  @@index([name]) // For text search
  @@map("products")
}

model ProductImage {
  id           String   @id @default(cuid())
  url          String
  key          String // S3/Storage key for deletion
  altText      String?  @map("alt_text")
  displayOrder Int      @default(0) @map("display_order")
  productId    String   @map("product_id")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([displayOrder])
  @@map("product_images")
}

model VariantType {
  id          String  @id @default(cuid())
  name        String // e.g., "Size", "Color", "Flavor"
  displayName String? @map("display_name")
  productId   String  @map("product_id")

  // Relations
  product Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  values  VariantValue[]

  @@index([productId])
  @@map("variant_types")
}

model VariantValue {
  id            String  @id @default(cuid())
  value         String // e.g., "Red", "Large", "100ml"
  displayValue  String? @map("display_value")
  variantTypeId String  @map("variant_type_id")

  // Relations
  variantType       VariantType        @relation(fields: [variantTypeId], references: [id], onDelete: Cascade)
  combinationValues CombinationValue[]

  @@index([variantTypeId])
  @@map("variant_values")
}

model ProductVariantCombination {
  id             String   @id @default(cuid())
  productId      String   @map("product_id")
  sku            String?  @unique
  price          Decimal  @db.Decimal(10, 2)
  compareAtPrice Decimal? @map("compare_at_price") @db.Decimal(10, 2)
  stock          Int      @default(0)
  imageUrl       String?  @map("image_url")
  isActive       Boolean  @default(true) @map("is_active")

  // Relations
  product    Product            @relation(fields: [productId], references: [id], onDelete: Cascade)
  values     CombinationValue[]
  orderItems OrderItem[]

  @@index([productId])
  @@index([isActive])
  @@map("product_variant_combinations")
}

model CombinationValue {
  id             String @id @default(cuid())
  combinationId  String @map("combination_id")
  variantValueId String @map("variant_value_id")

  // Relations
  combination  ProductVariantCombination @relation(fields: [combinationId], references: [id], onDelete: Cascade)
  variantValue VariantValue              @relation(fields: [variantValueId], references: [id], onDelete: Restrict)

  @@unique([combinationId, variantValueId])
  @@index([combinationId])
  @@index([variantValueId])
  @@map("combination_values")
}

model Review {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  productId    String?  @map("product_id")
  medicineId   String?  @map("medicine_id")
  rating       Int // 1-5
  title        String?
  comment      String?  @db.Text
  isVerified   Boolean  @default(false) @map("is_verified") // Verified purchase
  isApproved   Boolean  @default(false) @map("is_approved")
  helpfulCount Int      @default(0) @map("helpful_count")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  product  Product?  @relation(fields: [productId], references: [id], onDelete: Cascade)
  medicine Medicine? @relation(fields: [medicineId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([productId])
  @@index([medicineId])
  @@index([rating])
  @@index([isApproved])
  @@index([createdAt])
  @@map("reviews")
}

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ENUMS

// USER MANAGEMENT

// PRODUCT CATALOG

// PRODUCT VARIANTS

// MEDICINE CATALOG

// SHOPPING CART

// WISHLIST

// ORDERS

// PAYMENTS

// COUPONS & PROMOTIONS

// REVIEWS & RATINGS

// NOTIFICATIONS

model User {
  id                String    @id @default(cuid())
  name              String?
  email             String?   @unique
  phoneNumber       String    @unique @map("phone_number")
  role              UserRole  @default(USER)
  isActive          Boolean   @default(true) @map("is_active")
  isEmailVerified   Boolean   @default(false) @map("is_email_verified")
  isPhoneVerified   Boolean   @default(false) @map("is_phone_verified")
  isProfileComplete Boolean   @default(false) @map("is_profile_complete")
  lastLoginAt       DateTime? @map("last_login_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  cartItems     CartItem[]
  orders        Order[]
  payments      Payment[]
  addresses     UserAddress[]
  wishlists     Wishlist[]
  reviews       Review[]
  notifications Notification[]

  @@index([email])
  @@index([phoneNumber])
  @@index([role])
  @@index([createdAt])
  @@map("users")
}

model UserAddress {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  fullName     String   @map("full_name")
  phoneNumber  String   @map("phone_number")
  addressLine1 String   @map("address_line1")
  addressLine2 String?  @map("address_line2")
  landmark     String?
  city         String
  state        String
  postalCode   String   @map("postal_code")
  country      String   @default("India")
  latitude     Float?
  longitude    Float?
  isDefault    Boolean  @default(false) @map("is_default")
  addressType  String?  @map("address_type") // HOME, WORK, OTHER
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders Order[]

  @@index([userId])
  @@index([isDefault])
  @@map("user_addresses")
}

model Wishlist {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  productId  String?  @map("product_id")
  medicineId String?  @map("medicine_id")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  product  Product?  @relation(fields: [productId], references: [id], onDelete: Cascade)
  medicine Medicine? @relation(fields: [medicineId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@unique([userId, medicineId])
  @@index([userId])
  @@index([productId])
  @@index([medicineId])
  @@map("wishlists")
}
